<div class="main-wrapper">
  <div class="content-wrapper">
    <div class="app-container">
      
      <!-- Header principal -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-0" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%); color: white;">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                  <h2 class="mb-1"><i class="fas fa-calendar-alt me-3"></i>Gestión de Citas</h2>
                  <p class="mb-0 opacity-75">Administra las citas odontológicas de tu clínica</p>
                </div>
                <a routerLink="/agendar-cita" class="btn btn-light hover-lift">
                  <i class="fas fa-plus me-2"></i>Nueva Cita
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensajes -->
      <div class="row mb-4" *ngIf="mensaje">
        <div class="col-12">
          <div class="alert alert-dismissible fade show slide-in" 
               [class.alert-success]="mensaje.includes('correctamente')"
               [class.alert-danger]="mensaje.includes('Error')" role="alert">
            <i class="fas me-2" 
               [class.fa-check-circle]="mensaje.includes('correctamente')"
               [class.fa-exclamation-triangle]="mensaje.includes('Error')"></i>
            {{ mensaje }}
            <button type="button" class="btn-close" (click)="mensaje = ''" aria-label="Close"></button>
          </div>
        </div>
      </div>

      <!-- Estadísticas -->
      <div class="row mb-4">
        <div class="col-xl-2 col-lg-3 col-md-4 col-6 mb-3">
          <div class="card text-center bg-primary text-white hover-lift fade-in h-100">
            <div class="card-body p-3">
              <i class="fas fa-calendar-check fa-2x mb-2 opacity-75"></i>
              <h4 class="mb-1">{{ estadisticas.total }}</h4>
              <small class="opacity-75">Total Citas</small>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-6 mb-3">
          <div class="card text-center bg-info text-white hover-lift fade-in h-100" style="animation-delay: 0.1s;">
            <div class="card-body p-3">
              <i class="fas fa-clock fa-2x mb-2 opacity-75"></i>
              <h4 class="mb-1">{{ estadisticas.programadas }}</h4>
              <small class="opacity-75">Programadas</small>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-6 mb-3">
          <div class="card text-center bg-success text-white hover-lift fade-in h-100" style="animation-delay: 0.2s;">
            <div class="card-body p-3">
              <i class="fas fa-check fa-2x mb-2 opacity-75"></i>
              <h4 class="mb-1">{{ estadisticas.completadas }}</h4>
              <small class="opacity-75">Completadas</small>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-6 mb-3">
          <div class="card text-center bg-danger text-white hover-lift fade-in h-100" style="animation-delay: 0.3s;">
            <div class="card-body p-3">
              <i class="fas fa-times fa-2x mb-2 opacity-75"></i>
              <h4 class="mb-1">{{ estadisticas.canceladas }}</h4>
              <small class="opacity-75">Canceladas</small>
            </div>
          </div>
        </div>
        <div class="col-xl-2 col-lg-3 col-md-4 col-6 mb-3">
          <div class="card text-center bg-warning text-white hover-lift fade-in h-100" style="animation-delay: 0.4s;">
            <div class="card-body p-3">
              <i class="fas fa-calendar-day fa-2x mb-2 opacity-75"></i>
              <h4 class="mb-1">{{ estadisticas.hoy }}</h4>
              <small class="opacity-75">Hoy</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card slide-in">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-filter me-2 text-primary"></i>Filtros de Búsqueda</h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label for="filtroFecha" class="form-label">Fecha</label>
                  <input 
                    type="date" 
                    class="form-control" 
                    id="filtroFecha"
                    [(ngModel)]="filtroFecha"
                    (ngModelChange)="aplicarFiltros()">
                </div>
                <div class="col-md-3">
                  <label for="filtroEstado" class="form-label">Estado</label>
                  <select 
                    class="form-select" 
                    id="filtroEstado"
                    [(ngModel)]="filtroEstado"
                    (ngModelChange)="aplicarFiltros()">
                    <option value="">Todos los estados</option>
                    <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="filtroPaciente" class="form-label">Paciente</label>
                  <select 
                    class="form-select" 
                    id="filtroPaciente"
                    [(ngModel)]="filtroPaciente"
                    (ngModelChange)="aplicarFiltros()">
                    <option value="">Todos los pacientes</option>
                    <option *ngFor="let paciente of pacientes" [value]="paciente._id">
                      {{ paciente.nombres }}
                    </option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="filtroOdontologo" class="form-label">Odontólogo</label>
                  <select 
                    class="form-select" 
                    id="filtroOdontologo"
                    [(ngModel)]="filtroOdontologo"
                    (ngModelChange)="aplicarFiltros()">
                    <option value="">Todos los odontólogos</option>
                    <option *ngFor="let odontologo of odontologos" [value]="odontologo._id">
                      {{ odontologo.nombre }} - {{ odontologo.especialidad }}
                    </option>
                  </select>
                </div>
                <div class="col-12 text-end">
                  <button type="button" class="btn btn-outline-secondary hover-lift" (click)="limpiarFiltros()">
                    <i class="fas fa-eraser me-2"></i>Limpiar Filtros
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div class="row" *ngIf="cargando">
        <div class="col-12">
          <div class="card">
            <div class="card-body text-center py-5">
              <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-3 text-muted">Cargando citas...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Citas -->
      <div class="row" *ngIf="!cargando">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-table me-2 text-primary"></i>Citas Registradas</h5>
              <span class="badge bg-secondary">{{ citasFiltradas.length }} resultados</span>
            </div>
            <div class="card-body p-0">
              
              <!-- Tabla -->
              <div class="table-responsive" *ngIf="citasFiltradas.length > 0">
                <table class="table table-hover mb-0">
                  <thead style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%); color: white;">
                    <tr>
                      <th class="border-0 py-3">Fecha y Hora</th>
                      <th class="border-0 py-3">Paciente</th>
                      <th class="border-0 py-3">Odontólogo</th>
                      <th class="border-0 py-3">Motivo</th>
                      <th class="border-0 py-3">Estado</th>
                      <th class="border-0 py-3">Observaciones</th>
                      <th class="border-0 py-3">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let cita of citasPaginadas; trackBy: trackByCita" 
                        [class.table-warning]="esCitaHoy(cita)"
                        [class.table-secondary]="esCitaPasada(cita) && cita.estado !== 'Completada'"
                        class="hover-lift">
                      <td class="py-3">
                        <div>
                          <strong class="d-block">{{ formatearFecha(cita.fecha) }}</strong>
                          <small class="text-muted">{{ cita.hora }}</small>
                          <span *ngIf="esCitaHoy(cita)" class="badge bg-warning text-dark ms-2">HOY</span>
                        </div>
                      </td>
                      <td class="py-3">
                        <div>
                          <strong class="d-block">{{ cita.pacienteInfo?.nombres || 'Sin nombre' }}</strong>
                          <small class="text-muted">{{ cita.pacienteInfo?.telefono || 'Sin teléfono' }}</small>
                        </div>
                      </td>
                      <td class="py-3">
                        <div>
                          <strong class="d-block">{{ cita.odontologoInfo?.nombre || 'Sin nombre' }}</strong>
                          <small class="text-muted">{{ cita.odontologoInfo?.especialidad || 'Sin especialidad' }}</small>
                        </div>
                      </td>
                      <td class="py-3">
                        <span [title]="cita.motivo">
                          {{ cita.motivo && cita.motivo.length > 30 ? (cita.motivo | slice:0:30) + '...' : cita.motivo }}
                        </span>
                      </td>
                      <td class="py-3">
                        <span [class]="getEstadoClass(cita.estado)">{{ cita.estado }}</span>
                      </td>
                      <td class="py-3">
                        <span *ngIf="cita.observaciones" [title]="cita.observaciones">
                          {{ cita.observaciones.length > 20 ? (cita.observaciones | slice:0:20) + '...' : cita.observaciones }}
                        </span>
                        <small *ngIf="!cita.observaciones" class="text-muted">Sin observaciones</small>
                      </td>
                      <td class="py-3">
                        <div class="btn-group btn-group-sm">
                          <button 
                            type="button"
                            class="btn btn-outline-primary"
                            (click)="abrirModalEditar(cita)"
                            title="Editar">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button 
                            type="button"
                            class="btn btn-outline-danger"
                            (click)="eliminarCita(cita)"
                            title="Eliminar">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Estado vacío -->
              <div *ngIf="citasFiltradas.length === 0" class="text-center py-5">
                <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontraron citas</h5>
                <p class="text-muted">Intenta ajustar los filtros o agenda una nueva cita</p>
                <a routerLink="/agendar-cita" class="btn btn-primary hover-lift">
                  <i class="fas fa-plus me-2"></i>Agendar Primera Cita
                </a>
              </div>

            </div>

            <!-- Paginación -->
            <div class="card-footer bg-light" *ngIf="totalPaginas > 1">
              <nav>
                <ul class="pagination justify-content-center mb-0">
                  <li class="page-item" [class.disabled]="paginaActual === 1">
                    <a class="page-link" (click)="cambiarPagina(paginaActual - 1)" style="cursor: pointer;">
                      <i class="fas fa-chevron-left"></i>
                    </a>
                  </li>
                  <li *ngFor="let numero of getPaginasArray()" 
                      class="page-item" [class.active]="numero === paginaActual">
                    <a class="page-link" (click)="cambiarPagina(numero)" style="cursor: pointer;">{{ numero }}</a>
                  </li>
                  <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
                    <a class="page-link" (click)="cambiarPagina(paginaActual + 1)" style="cursor: pointer;">
                      <i class="fas fa-chevron-right"></i>
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal de Edición -->
<div class="modal fade" [class.show]="mostrandoModal" [style.display]="mostrandoModal ? 'block' : 'none'"
     tabindex="-1" *ngIf="mostrandoModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Cita</h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
      </div>
      <form [formGroup]="formularioEditar" (ngSubmit)="guardarCambios()">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="editFecha" class="form-label">Fecha *</label>
              <input type="date" class="form-control" id="editFecha" formControlName="fecha">
            </div>
            <div class="col-md-6">
              <label for="editHora" class="form-label">Hora *</label>
              <select class="form-select" id="editHora" formControlName="hora">
                <option value="">Selecciona una hora</option>
                <option *ngFor="let hora of horasDisponibles" [value]="hora">{{ hora }}</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editPaciente" class="form-label">Paciente *</label>
              <select class="form-select" id="editPaciente" formControlName="paciente">
                <option value="">Selecciona un paciente</option>
                <option *ngFor="let paciente of pacientes" [value]="paciente._id">
                  {{ paciente.nombres }}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editOdontologo" class="form-label">Odontólogo *</label>
              <select class="form-select" id="editOdontologo" formControlName="odontologo">
                <option value="">Selecciona un odontólogo</option>
                <option *ngFor="let odontologo of odontologos" [value]="odontologo._id">
                  {{ odontologo.nombre }} - {{ odontologo.especialidad }}
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editEstado" class="form-label">Estado *</label>
              <select class="form-select" id="editEstado" formControlName="estado">
                <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
              </select>
            </div>
            <div class="col-md-12">
              <label for="editMotivo" class="form-label">Motivo *</label>
              <textarea class="form-control" id="editMotivo" formControlName="motivo" rows="3"></textarea>
            </div>
            <div class="col-md-12">
              <label for="editObservaciones" class="form-label">Observaciones</label>
              <textarea class="form-control" id="editObservaciones" formControlName="observaciones" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-outline-secondary" (click)="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="formularioEditar.invalid">
            <i class="fas fa-save me-2"></i>Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="mostrandoModal" *ngIf="mostrandoModal"></div>